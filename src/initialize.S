.section .text
.global _initialize_page_table
.global _initialize_mmu

.equ PAGE_TABLE_ADDR, 0x20080000 

_initialize_mmu:

# 分岐予測器の無効化(BPIALL)
mov r0, #0
mcr p15, 0, r0, c7, c5, 6

# TLBの無効化(TLBIALL)
mov r0, #0
mcr p15, 0, r0, c8, c7, 0

# =============================================================================
# テーブル変換ベース制御レジスタ(TTBR) 設定
# EAE 0:32bitアドレス変換
# PD1 1:TTBR1ウォーク禁止
# PD0 0:TTBR0ウォーク許可
#   N 0:16KB
# =============================================================================
mov r0, #0x20
mcr p15, 0, r0, c2, c0, 2

# =============================================================================
# ドメインアクセス制御レジスタ(DACR)設定
# D0～15 01: クライアント(変換テーブルに従う)
# =============================================================================
ldr r0, =0x55555555
mcr p15, 0, r0, c3, c0, 0

# =============================================================================
# 第1変換ページテーブル設定
# =============================================================================
ldr r0, =#PAGE_TABLE_ADDR
push {lr}
bl initialize_page_table
pop {lr}

# 変換テーブルベースレジスタ0(TTBR0)設定
ldr r0, =#PAGE_TABLE_ADDR
#orr  r0, r0, #0x01
mcr p15, 0, r0, c2, c0, 0

/*
# レベル1 命令キャッシュ無効化
mov r0, #0x00
mcr p15, 0, r0, c7,c5,0

# レベル1 データキャッシュ無効化
mov r0, #0x00
mcr p15, 0, r0, c7,c5,0

# レベル2 統合キャッシュの無効化
mov r0, #0x00
mcr p15, 0, r0, c7,c5,0
*/

# =============================================================================
# データ同期バリア
# =============================================================================
dsb

# =============================================================================
# MMU有効化(SCTLRの設定)
# =============================================================================
mrc  p15, 0, r0, c1, c0, 0      // SCTLRを読み込み
//orr  r0, r0, #0x1000          // 命令キャッシュ有効化
//orr  r0, r0, #0x4             // データキャッシュ無効化
orr  r0, r0, #0x01              // MMUを稼働状態に設定
mcr  p15, 0, r0, c1, c0, 0      // SCTLRに書き込み
isb                             // 命令同期バリア
bx lr
